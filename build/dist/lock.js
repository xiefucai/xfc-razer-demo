var k=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function m(h,c,l){return l={path:c,exports:{},require:function(f,s){return x(f,s==null?l.path:s)}},h(l,l.exports),l.exports}function x(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var q=m(function(h,c){c.__esModule=!0;var l=function(){function s(r,o,e){this.table=o,this.tx=r.transaction(o,e)}return s.prototype.add=function(r){var o=this;return new Promise(function(e,a){var i=o.tx.objectStore(o.table),t=[];Array.isArray(r)?r.forEach(function(u){t.push(i.add(u))}):t.push(i.add(r)),o.tx.oncomplete=function(){Array.isArray(r)?e(t.map(function(u){return u.result})):e(t[0].result)},o.tx.onerror=function(){this.error&&a(this.error)}})},s}(),f=function(){function s(r){this.db=null,this.db_name="",this.db_name=r}return s.prototype.open=function(r){var o=this,e=this;return new Promise(function(a,i){var t=window.indexedDB.open(o.db_name,r.version);t.onsuccess=function(u){e.db=t.result,a(e.db)},t.onupgradeneeded=function(u){var b=u.target.result;b.onerror=function(n){i(n)},e.db=b,r.objectStores.forEach(function(n){var d=b.createObjectStore(n.name,{keyPath:n.keyPath,autoIncrement:n.autoIncrement});n.indexes.forEach(function(v){var L=v.name,_=v.keyPath,E=v.multiEntry,S=v.unique;d.createIndex(L,_,{unique:S,multiEntry:E})})});var y=u.target.transaction;y&&(y.oncomplete=function(){a(b)})}})},s.prototype.choose=function(r,o){if(this.db)return new l(this.db,r,o);throw new Error("db is not opened")},s}();c.default=f}),H=m(function(h,c){c.__esModule=!0;var l=function(){function f(){var s=this;this.list={},this.on=function(r,o){if(s.list[r]){if(s.list[r].includes(o))return;s.list[r].push(o)}else s.list[r]=[o]},this.publish=function(r){for(var o=[],e=1;e<arguments.length;e++)o[e-1]=arguments[e];Array.isArray(s.list[r])&&s.list[r].forEach(function(a){a.apply(void 0,o)})}}return f}();c.default=l}),B=m(function(h,c){var l=k&&k.__awaiter||function(r,o,e,a){function i(t){return t instanceof e?t:new e(function(u){u(t)})}return new(e||(e=Promise))(function(t,u){function b(d){try{n(a.next(d))}catch(v){u(v)}}function y(d){try{n(a.throw(d))}catch(v){u(v)}}function n(d){d.done?t(d.value):i(d.value).then(b,y)}n((a=a.apply(r,o||[])).next())})},f=k&&k.__generator||function(r,o){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},a,i,t,u;return u={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function b(n){return function(d){return y([n,d])}}function y(n){if(a)throw new TypeError("Generator is already executing.");for(;e;)try{if(a=1,i&&(t=n[0]&2?i.return:n[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,n[1])).done)return t;switch(i=0,t&&(n=[n[0]&2,t.value]),n[0]){case 0:case 1:t=n;break;case 4:return e.label++,{value:n[1],done:!1};case 5:e.label++,i=n[1],n=[0];continue;case 7:n=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(n[0]===6||n[0]===2)){e=0;continue}if(n[0]===3&&(!t||n[1]>t[0]&&n[1]<t[3])){e.label=n[1];break}if(n[0]===6&&e.label<t[1]){e.label=t[1],t=n;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(n);break}t[2]&&e.ops.pop(),e.trys.pop();continue}n=o.call(r,e)}catch(d){n=[6,d],i=0}finally{a=t=0}if(n[0]&5)throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}};c.__esModule=!0;var s=function(){function r(){this.state=0,this.controller=new AbortController,this.unlock=null,this.puber=new H.default}return r.prototype.lock=function(o,e){return l(this,void 0,void 0,function(){var a=this;return f(this,function(i){switch(i.label){case 0:if(typeof navigator.locks=="undefined")throw new Error("Your browser does not support Web Locks API.");return[4,navigator.locks.request(o,{signal:this.controller.signal},function(t){return l(a,void 0,void 0,function(){return f(this,function(u){switch(u.label){case 0:return this.puber.publish("locked"),[4,e()];case 1:return u.sent(),this.puber.publish("unlocked"),console.log("unlocked",t),[2]}})})})];case 1:return[2,i.sent()]}})})},r.prototype.stealLock=function(o,e){return l(this,void 0,void 0,function(){var a=this;return f(this,function(i){switch(i.label){case 0:if(typeof navigator.locks=="undefined")throw new Error("Your browser does not support Web Locks API.");return[4,navigator.locks.request(o,{steal:!0},function(t){return l(a,void 0,void 0,function(){return f(this,function(u){switch(u.label){case 0:return this.puber.publish("locked"),[4,e()];case 1:return u.sent(),this.puber.publish("unlocked"),[2]}})})})];case 1:return[2,i.sent()]}})})},r.prototype.query=function(){return l(this,void 0,void 0,function(){return f(this,function(o){switch(o.label){case 0:return[4,navigator.locks.query()];case 1:return[2,o.sent()]}})})},r.prototype.unLock=function(){return l(this,void 0,void 0,function(){return f(this,function(o){return this.controller.abort(),[2]})})},r}();c.default=s}),g=m(function(h,c){c.__esModule=!0,c.ADBObjectStore=c.LockHolder=void 0,c.ADBObjectStore=q.default,c.LockHolder=B.default}),O=g.ADBObjectStore,A=g.LockHolder;var w=new A,j={release:async()=>{w.unlock&&w.unlock()}},p=document.getElementById("root");p.addEventListener("click",h=>{let c=h.target,l=j[c.value];c.id&&l&&j[c.value].bind(c)().catch(f=>{p.innerHTML=f?f.message:"error happed"})},!1);w.puber.on("unlocked",()=>{p.innerHTML="lock has been released in current tab",p.className=""});w.lock("test-locker",()=>(p.setAttribute("data-text","Locked by current page"),p.innerHTML='<input type="button" id="release" value="release"/>',new Promise(h=>{w.unlock=h}))).catch(h=>{p.innerHTML=`<div style="color: red;">${h.message}</div>`});
//# sourceMappingURL=lock.js.map
